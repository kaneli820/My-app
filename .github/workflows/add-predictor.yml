name: Add predictor scaffold

on:
  workflow_dispatch:

jobs:
  add-predictor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Create scaffold files (no heredoc)
        run: |
          set -e
          mkdir -p tradepulse-web/server
          mkdir -p tradepulse-web/src

          # server/index.js
          printf '%s\n' '/* Minimal backend (index.js) */' \
            'const express = require("express");' \
            'const axios = require("axios");' \
            'const cors = require("cors");' \
            'require("dotenv").config();' \
            '' \
            'const app = express();' \
            'app.use(cors());' \
            'app.use(express.json());' \
            '' \
            'const PORT = process.env.PORT || 4000;' \
            '' \
            'app.get("/healthz", (_req, res) => res.json({ ok: true }));' \
            '' \
            'app.post("/api/predict", (_req, res) => {' \
            '  res.json({ message: "Replace with real predict logic" });' \
            '});' \
            '' \
            'app.listen(PORT, () => console.log("Predictor API listening on http://localhost:" + PORT));' \
            > tradepulse-web/server/index.js

          # server/package.json
          printf '%s\n' '{' \
            '  "name": "tradepulse-server",' \
            '  "version": "1.0.0",' \
            '  "main": "index.js",' \
            '  "scripts": { "start": "node index.js" },' \
            '  "dependencies": { "axios": "^1.4.0", "cors": "^2.8.5", "dotenv": "^16.3.1", "express": "^4.18.2" }' \
            '}' \
            > tradepulse-web/server/package.json

          # server/.env.example
          printf '%s\n' '# Copy to server/.env and set your key' 'TWELVEDATA_KEY=your_twelvedata_api_key_here' \
            > tradepulse-web/server/.env.example

          # src/main.jsx
          printf '%s\n' 'import React from "react";' \
            'import ReactDOM from "react-dom/client";' \
            'import App from "./App";' \
            'import "./index.css";' \
            '' \
            'ReactDOM.createRoot(document.getElementById("root")).render(' \
            '  React.createElement(React.StrictMode, null, React.createElement(App))' \
            ');' \
            > tradepulse-web/src/main.jsx

          # src/App.jsx (minimal placeholder - replace later)
          printf '%s\n' 'import React from "react";' \
            '' \
            'export default function App() {' \
            '  return (' \
            '    React.createElement("div", { style: { padding: 20, fontFamily: \"Arial\" } },' \
            '      React.createElement("h1", null, "TradePulse (scaffold)")' \
            '    )' \
            '  );' \
            '}' \
            > tradepulse-web/src/App.jsx

          # src/index.css
          printf '%s\n' 'body { margin: 0; font-family: Arial, sans-serif; background: #f8f9fa; }' \
            > tradepulse-web/src/index.css

          # vite.config.js
          printf '%s\n' 'import { defineConfig } from "vite";' \
            'import react from "@vitejs/plugin-react";' \
            '' \
            'export default defineConfig({' \
            '  plugins: [react()], ' \
            '  server: {' \
            '    proxy: { "/api": { target: "http://localhost:4000", changeOrigin: true } }' \
            '  }' \
            '});' \
            > tradepulse-web/vite.config.js

      - name: Create branch and commit files
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: add tradepulse scaffold"
          branch: add/tradepulse-predictor
          title: "Add TradePulse predictor scaffold"
          body: "Adds backend scaffold and minimal frontend files."
